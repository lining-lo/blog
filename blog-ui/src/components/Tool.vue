<template>
    <div class="tool">
        <span v-if="route.name === 'message'" @click="showCreateMessage">📫</span>
        <span v-if="route.name === 'article'" @click="showCatalog">🕹️</span>
        <span @click="toTop">🚁</span>
        <span @click="outerVisible = true">🔍</span>
        <span @click="toListen">🎸</span>
        <span @click="toChat">📻</span>
        <el-dialog :show-close="false" v-model="outerVisible" width="600">
            <div class="search"
                :style="{ opacity: isDark ? 0.8 : 1, backgroundImage: `url(src/assets/images/${isDark ? 'dark' : 'light'}-search.webp)` }">
                <div class="search-title">🔍搜索</div>
                <div class="search-input">
                    <input type="text" v-model="searchKeyword" @keyup.enter="filteredArticles">
                    <button @click="filteredArticles">搜索</button>
                </div>
                <div class="search-content" v-if="!isShowRecomment">
                    <div class="search-item" v-for="item in searchResult" :key="item.id">
                        <p class="title" @click="toArticle(item)" v-html="item.name"></p>
                        <p class="text" style="margin: 5px 0;" v-html="item.content"></p>
                    </div>
                </div>
                <div class="search-recommend" v-else>
                    <div class="news-item"
                        :style="{ backgroundColor: isDark ? 'rgba(207, 185, 185, 0.4)' : 'rgba(40, 40, 40, 0.4)' }"
                        v-for="(item, index) in hotArticle" :key="index">
                        <div class="item-num">{{ index + 1 }}</div>
                        <div class="item-txt" @click="toArticle(item)">{{ item.name }}</div>
                    </div>
                </div>
                <div class="search-tip" style="margin-top: 16px;color: aliceblue;" v-if="!isShowRecomment">
                    一共找到 {{ searchResult.length }} 条结果
                </div>
            </div>
        </el-dialog>
    </div>
</template>

<script setup lang='ts'>
import { ElMessage } from 'element-plus';
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router';
import { useArticleStore, useTimeStore, useToolStore } from '../store';
import { storeToRefs } from 'pinia';

//实例化route
const route = useRoute()

const outerVisible = ref(false)

// 实例化 Store
const toolStore = useToolStore()
const timeStore = useTimeStore()
const articleStore = useArticleStore()
// 解构 State（自动转为响应式 ref）
const { isShowCatalog, isShowCreateMessage } = storeToRefs(toolStore)
const { isDark, componentKey } = storeToRefs(timeStore)
const { article } = storeToRefs(articleStore)

const showCatalog = () => {
    isShowCatalog.value = !isShowCatalog.value
}
const showCreateMessage = () => {
    isShowCreateMessage.value = !isShowCreateMessage.value
}

// 滚动条回到顶部
const toTop = () => {
    // 获取当前滚动位置
    const startScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const duration = 500; // 动画持续时间（毫秒）
    const startTime = performance.now();
    // 动画函数
    const animateScroll = (currentTime) => {
        const elapsedTime = currentTime - startTime;
        // 计算动画进度（0-1）
        const progress = Math.min(elapsedTime / duration, 1);
        // 使用缓动函数使动画更平滑（减速效果）
        const easeOutProgress = progress * (2 - progress);
        // 计算当前应该滚动到的位置
        const currentScroll = startScroll - (startScroll * easeOutProgress);
        // 执行滚动
        document.body.scrollTop = currentScroll;
        document.documentElement.scrollTop = currentScroll;
        // 如果动画未完成，继续下一帧
        if (progress < 1) {
            requestAnimationFrame(animateScroll);
        }
    };
    // 开始动画
    requestAnimationFrame(animateScroll);
};

const toListen = () => {
    ElMessage.warning('音乐播放器尚未开发，敬请期待！')
}

const toChat = () => {
    ElMessage.warning('在线聊天室尚未开发，敬请期待！')
}

// 挂载
onMounted(() => {
    articleStore.getArticle();
})
// 推荐的文章
const hotArticle = computed(() => {
    return article.value
        .sort((a, b) => {
            // 确保观看次数存在，默认为0
            const countA = a.count || 0;
            const countB = b.count || 0;
            return countB - countA; // 降序排列（从高到低）
        }).slice(0, 10);
})
const router = useRouter()
// 查看文章
const toArticle = (item: any) => {
    router.push({
        name: 'article',
        query: { id: item.id }
    });
    componentKey.value += 1
    outerVisible.value = false
}
// 控制推荐|搜索的显示
const isShowRecomment = ref(true)
// 搜索的关键字
const searchKeyword = ref('')
// 搜索到的文章
const searchResult = ref([])
watch(searchKeyword, (newValue, oldValue) => {
    if (newValue.length === 0) {
        isShowRecomment.value = true
    }
})
// 搜索文章的方法
const filteredArticles = () => {
    // 关键词为空时返回全部文章  
    if (!searchKeyword.value.trim()) {
        return ElMessage.warning('请输入要搜索的内容')
    }
    const keyword = searchKeyword.value.toLowerCase().trim()
    // 搜索的的结果
    const result = article.value.filter(item => {
        // 在标题或内容中搜索关键词（忽略大小写）
        return item.name.toLowerCase().includes(keyword) ||
            item.content.toLowerCase().includes(keyword)
    })
    // 复制一份查找的结果做处理，避免污染数据
    const copyResult = JSON.parse(JSON.stringify(result))
    // 对结果高亮处理
    for (let i = 0; i < copyResult.length; i++) {
        copyResult[i].name = highlightMatchTitle(copyResult[i].name)
        copyResult[i].content = highlightMatchContent(copyResult[i].content)
    }
    searchResult.value = copyResult
    isShowRecomment.value = false
}
const highlightMatchTitle = (text: any) => {
    const regex = new RegExp(searchKeyword.value, 'gi')
    return text.replace(regex, match => `<span class="highlight">${match}</span>`)
}
const highlightMatchContent = (text: string) => {
    // 1. 处理原始内容为空的情况
    if (!text) {
        return '<span class="empty-content">无内容预览</span>';
    }

    // 2. 关键词为空时返回前50字预览
    if (!searchKeyword.value.trim()) {
        return text.length > 50 ? text.substring(0, 50) + '...' : text;
    }

    const keyword = searchKeyword.value.trim();
    // 3. 转义正则特殊字符（避免语法错误）
    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // 只匹配第一个结果（不加 'g' 修饰符）
    const regex = new RegExp(escapedKeyword, 'i'); // 仅忽略大小写，不全局匹配

    // 4. 查找第一个匹配位置
    const matchResult = text.match(regex);
    if (!matchResult) {
        // 无匹配时返回前30字
        return text.length > 30 ? text.substring(0, 30) + '...' : text;
    }

    // 5. 提取第一个匹配的信息
    const firstMatch = matchResult[0]; // 第一个匹配的文本
    const matchIndex = matchResult.index as number; // 第一个匹配的起始位置
    const matchLength = firstMatch.length; // 第一个匹配的长度

    // 6. 计算截取范围（上下文+匹配内容）
    const contextBefore = 10; // 匹配前显示10个字符
    const contextAfter = 20; // 匹配后显示20个字符
    const startIndex = Math.max(0, matchIndex - contextBefore);
    const endIndex = Math.min(
        matchIndex + matchLength + contextAfter,
        text.length
    );

    // 7. 处理截取范围异常（避免空字符串）
    if (startIndex >= endIndex) {
        return text.length > 30 ? text.substring(0, 30) + '...' : text;
    }

    // 8. 截取片段并高亮第一个匹配
    const snippet = text.substring(startIndex, endIndex);
    // 仅替换第一个匹配（因 regex 无 'g' 修饰符）
    const highlightedSnippet = snippet.replace(regex, (match) =>
        `<span class="highlight">${match}</span>`
    );

    // 9. 添加省略号（表示截断）
    const prefix = startIndex > 0 ? '...' : '';
    const suffix = endIndex < text.length ? '...' : '';

    return prefix + highlightedSnippet + suffix;
};

</script>
<style lang='less' scoped>
.tool {
    font-size: 30px;
    width: 30px;
    position: fixed;
    bottom: 12vh;
    right: 3vh;
    z-index: 1000;

    span {
        width: 40x;
        height: 30px;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        cursor: pointer;
    }
}

::v-deep .el-dialog {
    padding: 0;
    border-radius: 10px;
    box-shadow: 0 1px 20px -6px rgba(0, 0, 0, 0.5);
    z-index: 9999 !important;
    background-color: black;

    .el-dialog__header {
        display: none;
    }

    .search {
        width: 100%;
        margin: 0 auto;
        border-radius: 10px;
        padding: 20px 50px;
        background-image: url(../assets/images/light-search.webp);
        background-size: cover;
        background-position: center;
        font-family: auto;
        cursor: default;

        .search-title {
            font-size: 17x;
            margin-top: 14px;
            margin-bottom: 5px;
            color: #9485f2;
        }

        .search-input {
            padding: 4px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;

            input {
                height: 28px;
                width: 412px;
                font-size: 14px;
                padding: 6px 12px;
                border-radius: 10px 0 0 10px;
                background-color: transparent;
                border: 2px solid #9485f2;
                color: #9485f2;
                outline: none;
            }

            button {
                height: 28px;
                font-size: 12px;
                padding: 4px 20px;
                border-radius: 0 10px 10px 0;
                background-color: #9485f2;
                font-size: 12px;
                color: #fff;
            }
        }

        .search-content {
            width: 100%;
            height: 300px;
            overflow: auto;
            padding: 0 5px;

            .search-item {
                margin: 12px 0;
                padding: 4px 14px;
                background-color: rgba(40, 40, 40, 0.4);
                color: #fff;

                .title {
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                }

                .highlight {
                    color: #e34b4f;
                }
            }
        }

        .search-recommend {
            width: 100%;
            height: 314px;
            overflow: auto;
            margin-top: 10px;

            &>:nth-child(1) {
                .item-num {
                    background-color: #ff4d4f !important;
                    color: #fff;
                }
            }

            &>:nth-child(2) {
                .item-num {
                    background-color: orange !important;
                    color: #fff;
                }
            }

            &>:nth-child(3) {
                .item-num {
                    background-color: rgb(207, 174, 114) !important;
                    color: #fff;
                }
            }

            .news-item {
                display: flex;
                align-items: center;
                margin: 10px 12px;
                padding: 2px 10px;
                font-size: 14px;
                background-color: rgba(40, 40, 40, 0.4);
                color: #fff;

                .item-num {
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    background-color: #d9d9d9;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-right: 8px;
                    font-weight: 700;
                }

                .item-txt {
                    cursor: pointer;
                    letter-spacing: 1px;

                    &:hover {
                        color: #e34b4f;
                    }
                }
            }
        }
    }
}
</style>